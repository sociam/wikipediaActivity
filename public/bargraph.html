<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .bar {
        fill: steelblue;
    }
    .bar:hover {
        fill: brown;
    }
    .axis {
        font: 10px sans-serif;
    }
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    .x.axis path {
        display: none;
    }
</style>

<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="d3-cloud/lib/d3/d3.js"></script>
    <script src="d3-cloud/d3.layout.cloud.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script>
        langCounts = {}

        var socket = io.connect('http://sociamvm-app-001.ecs.soton.ac.uk:9001');

        var padding = 40;
        var margin = {
            top: 30,
            right: 30,
            bottom: 30,
            left: 100
        };
        var w = 700 - margin.left - margin.right;
        var h = 400 - margin.top - margin.bottom;
        var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var data = langCounts;

        var max_n = 0;
        for (var d in data) {
            max_n = Math.max(data[d].value, max_n);
        }

        var dx = w / max_n;
        var dy = h / data.length;

        // bars
        var bar = svg.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", function(d, i) { return "bar " + d.value; })
            .attr("x", function(d, i) { return 0;  })
            .attr("y", function(d, i) { return dy * i; })
            .attr("width", function(d, i) { return dx * d.n; })
            .attr("height", dy);

        // labels
        var lab = svg.selectAll("text")
            .data(data)
            .enter()
            .append("text")
            .attr("class", function(d, i) {
                return "label " + d.key;
            })
            .attr("x", 5)
            .attr("y", function(d, i) {
                return dy * i + 15;
            })
            .text(function(d) {
                return d.key + " (" + d.n + ")";
            })
            .attr("font-size", "15px")
            .style("font-weight", "bold");

        function draw() {
            svg.selectAll(".bar")
                .data(data).enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(d) {  return x(d.key); })
                .attr("y", function(d) {   return y(d.value);  })
                .attr("height", function(d) { return height - y(d.value); })
                .attr("width", x.rangeBand());
            // removed data:
            bar.exit().remove();
        }

        socket.on('news', function(data) {
            //console.log(data.wikipedia_page_name);
            if (data.wikipedia_language != undefined) {
                if (data.wikipedia_language in langCounts) {
                    langCounts[data.wikipedia_language] = langCounts[data.wikipedia_language] + 1;
                } else {
                    langCounts[data.wikipedia_language] = 0;
                }

                //langCounts = JSON.parse(langCounts);
                console.log(langCounts);
                draw();
                //words[data.wikipedia_page_name]= 1;
            }
        });
    </script>